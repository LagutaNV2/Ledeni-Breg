{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/application.css' %}">
{% endblock %}

{% block content %}
<div class="application-page">
    <div class="container">
        <div class="application-header">
            <h1>
                {% if current_language == 'ru' %}
                    Заявка на установку автомата
                {% else %}
                    Prijava za ugradnju automata
                {% endif %}
            </h1>
            <p>
                {% if current_language == 'ru' %}
                    Заполните форму ниже и наша команда свяжется с вами относительно установки автомата
                {% else %}
                    Popunite formular ispod i naš tim će Vas kontaktirati u vezi postavljanja automata
                {% endif %}
            </p>
        </div>

        <!-- Сообщение об успехе (сценарий 1) -->
        {% if show_success %}
        <div class="success-container" id="successMessage">
            <div class="success-icon">✓</div>
            <h2>
                {% if current_language == 'ru' %}
                    Заявка успешно отправлена!
                {% else %}
                    Uspešno ste poslali prijavu!
                {% endif %}
            </h2>
            <p>Vaša prijava je uspešno poslata. Kontaktiraćemo Vas u najkraćem roku.</p>
            <p>
                {% if current_language == 'ru' %}
                    Ваша заявка успешно отправлена. Свяжемся с вами в кратчайшие сроки.
                {% else %}
                    Vaša prijava je uspešno poslata. Kontaktiraćemo Vas u najkraćem roku.
                {% endif %}
            </p>
            <p class="countdown">
                {% if current_language == 'ru' %}
                    Перенаправление на главную страницу через <span id="countdown">60</span> секунд...
                {% else %}
                    Preusmeravanje na početnu stranu za <span id="countdown">60</span> sekundi...
                {% endif %}
            </p>
            <a href="{% url 'home' %}" class="btn btn-home">
                {% if current_language == 'ru' %}
                    Вернуться на главную страницу
                {% else %}
                    Vratite se na početnu stranu
                {% endif %}
            </a>
        </div>
        {% endif %}

        <!-- Форма (показывается только если нет успеха и нет ошибки email) -->
        {% if not show_success and not show_email_error %}
        <form method="post" class="application-form" novalidate id="applicationForm">
            {% csrf_token %}

            <div class="form-section">
                <h3>
                    {% if current_language == 'ru' %}
                        Информация об автомате
                    {% else %}
                        Informacije o automatu
                    {% endif %}
                </h3>

                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.machine_type.id_for_label }}">
                            {% if current_language == 'ru' %}Тип автомата *{% else %}Tip automata *{% endif %}
                        </label>
                        {{ form.machine_type }}
                        {% if form.machine_type.errors %}
                        <div class="error-text">{{ form.machine_type.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.quantity.id_for_label }}">
                            {% if current_language == 'ru' %}Количество *{% else %}Količina *{% endif %}
                        </label>
                        {{ form.quantity }}
                        {% if form.quantity.errors %}
                        <div class="error-text">{{ form.quantity.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>
                    {% if current_language == 'ru' %}
                        Адрес установки
                    {% else %}
                        Adresa postavljanja
                    {% endif %}
                </h3>

                <div class="form-group">
                    <label for="{{ form.city.id_for_label }}">
                        {% if current_language == 'ru' %}Город *{% else %}Grad *{% endif %}
                    </label>
                    {{ form.city }}
                    {% if form.city.errors %}
                    <div class="error-text">{{ form.city.errors }}</div>
                    {% endif %}
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.street.id_for_label }}">
                            {% if current_language == 'ru' %}Улица *{% else %}Ulica *{% endif %}
                        </label>
                        {{ form.street }}
                        {% if form.street.errors %}
                        <div class="error-text">{{ form.street.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.building.id_for_label }}">
                            {% if current_language == 'ru' %}Номер здания *{% else %}Broj zgrade *{% endif %}
                        </label>
                        {{ form.building }}
                        {% if form.building.errors %}
                        <div class="error-text">{{ form.building.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>
                    {% if current_language == 'ru' %}
                        Контактная информация
                    {% else %}
                        Kontakt informacije
                    {% endif %}
                </h3>

                <div class="form-group">
                    <label for="{{ form.full_name.id_for_label }}">
                        {% if current_language == 'ru' %}Имя и фамилия *{% else %}Ime i prezime *{% endif %}
                    </label>
                    {{ form.full_name }}
                    {% if form.full_name.errors %}
                    <div class="error-text">{{ form.full_name.errors }}</div>
                    {% endif %}
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.phone.id_for_label }}">
                            {% if current_language == 'ru' %}Телефон *{% else %}Telefon *{% endif %}
                        </label>
                        {{ form.phone }}
                        {% if form.phone.errors %}
                        <div class="error-text">{{ form.phone.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.email.id_for_label }}">Email *</label>
                        {{ form.email }}
                        {% if form.email.errors %}
                        <div class="error-text">{{ form.email.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="form-group">
                    <label for="{{ form.comment.id_for_label }}">
                        {% if current_language == 'ru' %}
                            Дополнительная информация или пожелания
                        {% else %}
                            Dodatne informacije ili želje
                        {% endif %}
                    </label>
                    {{ form.comment }}
                    {% if form.comment.errors %}
                    <div class="error-text">{{ form.comment.errors }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="form-submit">
                <button type="submit" class="btn-submit">
                    {% if current_language == 'ru' %}Отправить заявку{% else %}Pošaljite prijavu{% endif %}
                </button>
            </div>
        </form>
        {% endif %}

        <!-- Просмотр данных заявки (сценарий 2) -->
        {% if show_email_error %}
        <div class="application-data">
            <h3>
                {% if current_language == 'ru' %}
                    Данные вашей заявки:
                {% else %}
                    Podaci vaše prijave:
                {% endif %}
            </h3>

            <div class="data-section">
                <h4>
                    {% if current_language == 'ru' %}
                        Информация об автомате
                    {% else %}
                        Informacije o automatu
                    {% endif %}
                </h4>
                <div class="data-row">
                    <div class="data-item">
                        <strong>
                            {% if current_language == 'ru' %}Тип автомата:{% else %}Tip automata:{% endif %}
                        </strong>
                        <span>
                            {% if form_data.machine_type == 'water' %}
                                {% if current_language == 'ru' %}Водомат{% else %}Vodomat{% endif %}
                            {% else %}
                                {% if current_language == 'ru' %}Игрушки{% else %}Igrački{% endif %}
                            {% endif %}
                        </span>
                    </div>
                    <div class="data-item">
                        <strong>
                            {% if current_language == 'ru' %}Количество:{% else %}Količina:{% endif %}
                        </strong>
                        <span>
                            {{ form_data.quantity }}
                            {% if current_language == 'ru' %}штук{% else %}komada{% endif %}
                        </span>
                    </div>
                </div>
            </div>

            <div class="data-section">
                <h4>
                    {% if current_language == 'ru' %}
                        Адрес установки
                    {% else %}
                        Adresa postavljanja
                    {% endif %}
                </h4>
                <div class="data-item">
                    <strong>
                        {% if current_language == 'ru' %}Адрес:{% else %}Adresa:{% endif %}
                    </strong>
                    <span>{{ form_data.city }}, {{ form_data.street }} {{ form_data.building }}</span>
                </div>
            </div>

            <div class="data-section">
                <h4>
                    {% if current_language == 'ru' %}
                        Контактная информация
                    {% else %}
                        Kontakt informacije
                    {% endif %}
                </h4>
                <div class="data-item">
                    <strong>
                        {% if current_language == 'ru' %}Имя и фамилия:{% else %}Ime i prezime:{% endif %}
                    </strong>
                    <span>{{ form_data.full_name }}</span>
                </div>
                <div class="data-row">
                    <div class="data-item">
                        <strong>
                            {% if current_language == 'ru' %}Телефон:{% else %}Telefon:{% endif %}
                        </strong>
                        <span>{{ form_data.phone }}</span>
                    </div>
                    <div class="data-item">
                        <strong>
                            {% if current_language == 'ru' %}Email:{% else %}Email:{% endif %}
                        </strong>
                        <span>{{ form_data.email }}</span>
                    </div>
                </div>
            </div>

            {% if form_data.comment %}
            <div class="data-section">
                <h4>
                    {% if current_language == 'ru' %}
                        Дополнительная информация
                    {% else %}
                        Dodatne informacije
                    {% endif %}
                </h4>
                <div class="data-item">
                    <span>{{ form_data.comment }}</span>
                </div>
            </div>
            {% endif %}

            <div class="data-note">
                <p>
                    {% if current_language == 'ru' %}
                        Ваша заявка успешно сохранена. Свяжемся с вами по телефону.
                    {% else %}
                        Vaša prijava je uspešno sačuvana. Kontaktiraćemo Vas putem telefona.
                    {% endif %}
                </p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Модальное окно для ошибок -->
{% if show_email_error or show_validation_error %}
<div class="modal-overlay" id="errorModal">
    <div class="modal">
        <div class="modal-header">
            <h3>
                {% if current_language == 'ru' %}
                    Ошибка при отправке
                {% else %}
                    Greška pri slanju
                {% endif %}
            </h3>
        </div>
        <div class="modal-content">
            {% if show_email_error %}
            <p>
                {% if current_language == 'ru' %}
                    Ваша заявка сохранена, но произошла ошибка при отправке email уведомления. Свяжемся с вами по телефону.
                {% else %}
                    Vaša prijava je sačuvana, ali došlo je do greške pri slanju email obaveštenja. Kontaktiraćemo Vas putem telefona.
                {% endif %}
            </p>
            {% elif show_validation_error %}
            <p>
                {% if current_language == 'ru' %}
                    Произошла ошибка в форме. Пожалуйста, исправьте отмеченные поля ниже.
                {% else %}
                    Došlo je do greške u formularu. Molimo Vas ispravite označena polja ispod.
                {% endif %}
            </p>
            {% endif %}
        </div>
        <div class="modal-buttons">
            <button type="button" class="btn btn-close" onclick="closeModal()">
                {% if current_language == 'ru' %}Закрыть и посмотри форму{% else %}Zatvori i pogledaj zahtev{% endif %}
            </button>
            <a href="{% url 'home' %}" class="btn btn-home">
                {% if current_language == 'ru' %}Вернуться на главную страницу{% else %}Vratite se na početnu stranu{% endif %}
            </a>
        </div>
    </div>
</div>
{% endif %}

<script>
// Обработка успешной отправки
{% if show_success %}
document.addEventListener('DOMContentLoaded', function() {
    let secondsLeft = 60;
    const countdownElement = document.getElementById('countdown');
    const countdownInterval = setInterval(() => {
        secondsLeft--;
        countdownElement.textContent = secondsLeft;

        if (secondsLeft <= 0) {
            clearInterval(countdownInterval);
            window.location.href = "{% url 'home' %}";
        }
    }, 1000);

    // Резервный переход через 60 секунд
    setTimeout(() => {
        clearInterval(countdownInterval);
        window.location.href = "{% url 'home' %}";
    }, 60000);
});
{% endif %}

// Обработка модального окна с ошибками
{% if show_email_error or show_validation_error %}
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('errorModal');
    if (modal) {
        modal.style.display = 'flex';
        // Блокируем скроллинг body
        document.body.style.overflow = 'hidden';
    }
});

function closeModal() {
    const modal = document.getElementById('errorModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = '';
    }
}
{% endif %}

// Валидация телефона в реальном времени
document.addEventListener('DOMContentLoaded', function() {
    const phoneInput = document.querySelector('#id_phone');
    if (phoneInput) {
        phoneInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value) {
                if (value.startsWith('381')) {
                    value = '+' + value;
                } else if (!value.startsWith('+')) {
                    value = '+381' + value;
                }
            }
            e.target.value = value;
        });
    }
});

// Плавное появление формы
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('.application-form');
    if (form) {
        form.style.opacity = '0';
        form.style.transform = 'translateY(20px)';

        setTimeout(() => {
            form.style.transition = 'all 0.6s ease-out';
            form.style.opacity = '1';
            form.style.transform = 'translateY(0)';
        }, 100);
    }
});
</script>
{% endblock %}
