<!-- backend/templates/water/water.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Vodomat - Ledeni Breg{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

<link rel="stylesheet" href="{% static 'css/map.css' %}">
<link rel="stylesheet" href="{% static 'css/water.css' %}">
{% endblock %}

{% block content %}
<section class="water-page">
    <!-- –°–µ–∫—Ü–∏—è —Å —Ñ–æ–Ω–æ–º –≤–æ–ª–Ω: –∑–∞–≥–æ–ª–æ–≤–æ–∫ + —Ñ–æ—Ç–æ + –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    {% comment %} <div class="water-content-with-bg"> {% endcomment %}
    <div class="water-bg-wrapper">

        {% comment %} <div class="water-bg-wrap"> {% endcomment %}

        <!-- –§–æ–Ω —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div class="water-background">
            {% comment %} <div class="water-bg" aria-hidden="true"
                style="background-image: url('{% static 'images/full_water-bg.png' %}');">
            </div> {% endcomment %}

            <!-- PNG —Ñ–æ–Ω (–æ—Å–Ω–æ–≤–Ω–æ–π) -->
            <div class="water-bg-png"
                 style="background-image: url('{% static 'images/full_water-bg.png' %}');"
                 role="presentation"
                 aria-hidden="true">
            </div>

            <!-- SVG fallback (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
            <div class="water-bg-svg" role="presentation" aria-hidden="true">
                <img src="{% static 'images/waves.svg' %}" alt="" class="water-svg">
            </div>

            <!-- –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π –æ–≤–µ—Ä–ª–µ–π -->
            <div class="water-overlay"></div>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –ø–æ–≤–µ—Ä—Ö —Ñ–æ–Ω–∞ -->
        <div class="container water-content">
            <!-- –ì–µ—Ä–æ–π —Å–µ–∫—Ü–∏—è —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º -->
            <div class="hero-content">
                <h1 class="page-title">
                    {% if current_language == 'ru' %}
                        –ù–∞—à–∏ –≤–æ–¥–æ–º–∞—Ç—ã
                    {% else %}
                        Na≈°i vodomati
                    {% endif %}
                </h1>
                <p class="hero-subtitle">
                    {% if current_language == 'ru' %}
                        –ö—Ä–∏—Å—Ç–∞–ª—å–Ω–æ —á–∏—Å—Ç–∞—è –≤–æ–¥–∞ –≤ —É–¥–æ–±–Ω—ã—Ö –ª–æ–∫–∞—Ü–∏—è—Ö –ø–æ –≤—Å–µ–π –°–µ—Ä–±–∏–∏
                    {% else %}
                        Kristalno ƒçista voda na zgodnim lokacijama ≈°irom Srbije
                    {% endif %}
                </p>
            </div>

            <!-- –ë–ª–æ–∫ —Å –∞–≤—Ç–æ–º–∞—Ç–æ–º –∏ —Ç–µ–∫—Å—Ç–æ–º -->
            <div class="automats-block">
                <div class="automat-content">
                    <div class="automat-image">
                        <img src="{% static 'images/automats/automat-blu.png' %}"
                             alt="{% if current_language == 'ru' %}–í–æ–¥–æ–º–∞—Ç Ledeni Breg{% else %}Vodomat Ledeni Breg{% endif %}"
                             class="automat-img">
                    </div>
                    <div class="automat-text">
                        <h2>
                            {% if current_language == 'ru' %}
                                –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –ø–∏—Ç—å–µ–≤–∞—è –≤–æ–¥–∞
                            {% else %}
                                Kvalitetna voda za piƒáe
                            {% endif %}
                        </h2>
                        <div class="text-content">
                            <p>
                                {% if current_language == 'ru' %}
                                    –ù–∞—à–∏ –≤–æ–¥–æ–º–∞—Ç—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç –∫—Ä–∏—Å—Ç–∞–ª—å–Ω–æ —á–∏—Å—Ç—É—é –ø–∏—Ç—å–µ–≤—É—é –≤–æ–¥—É –≤—ã—Å—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞.
                                    –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ —É–¥–æ–±–Ω—ã—Ö –ª–æ–∫–∞—Ü–∏—è—Ö –ø–æ –≤—Å–µ–π –°–µ—Ä–±–∏–∏. –ö–∞–∂–¥—ã–π –∞–≤—Ç–æ–º–∞—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ
                                    –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞.
                                {% else %}
                                    Na≈°i vodomati pru≈æaju kristalno ƒçistu vodu za piƒáe najvi≈°eg kvaliteta.
                                    Postavljeni su na zgodnim lokacijama ≈°irom Srbije. Svaki automat prolazi redovno
                                    odr≈æavanje i kontrolu kvaliteta.
                                {% endif %}
                            </p>

                            <p>
                                {% if current_language == 'ru' %}
                                    –í–æ–¥–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç –º–Ω–æ–≥–æ—Å—Ç—É–ø–µ–Ω—á–∞—Ç—É—é —Å–∏—Å—Ç–µ–º—É –æ—á–∏—Å—Ç–∫–∏, –≤–∫–ª—é—á–∞—è –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫—É—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é,
                                    –æ–±—Ä–∞—Ç–Ω—ã–π –æ—Å–º–æ—Å –∏ —É–ª—å—Ç—Ä–∞—Ñ–∏–æ–ª–µ—Ç–æ–≤—É—é –¥–µ–∑–∏–Ω—Ñ–µ–∫—Ü–∏—é. –ú—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏
                                    –æ—Ç–ª–∏—á–Ω—ã–π –≤–∫—É—Å –Ω–∞—à–µ–π –≤–æ–¥—ã.
                                {% else %}
                                    Voda prolazi kroz vi≈°estepenu sistem ƒçi≈°ƒáenja, ukljuƒçujuƒái mehaniƒçku filtraciju,
                                    obrnutu osmozu i ultraljubiƒçastu dezinfekciju. Garantujemo bezbednost i
                                    odliƒçan ukus na≈°e vode.
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ë–ª–æ–∫ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ä—Ç—ã -->
    {% if has_map_access %}
    <div class="map-section">
        <div class="container">
            <h2 class="section-title">
                {% if current_language == 'ru' %}
                    –ù–∞–π–¥–∏—Ç–µ –≤–æ–¥–æ–º–∞—Ç —Ä—è–¥–æ–º —Å –≤–∞–º–∏
                {% else %}
                    Pronaƒëite vodomat u va≈°oj blizini
                {% endif %}
            </h2>
            <p class="map-hint" style="text-align: center; color: #666; margin-bottom: 1rem;">
                {% if current_language == 'ru' %}
                    –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É <strong>üìã</strong> –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö —Ç–æ—á–µ–∫
                {% else %}
                    Koristite dugme <strong>üìã</strong> za pregled liste svih lokacija
                {% endif %}
            </p>
            <div id="water-map" class="interactive-map"></div>
        </div>
    </div>
    {% endif %}
</section>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="{% static 'js/map-common.js' %}"></script>
<script src="{% static 'js/water-map.js' %}"></script>
<script>
    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ–Ω–∞
    function checkWaterBackground() {
        const pngBg = document.querySelector('.water-bg-png');
        const svgBg = document.querySelector('.water-bg-svg');
        const wrapper = document.querySelector('.water-background');

        // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ PNG
        const testImg = new Image();

        testImg.onload = function() {
            console.log('‚úÖ PNG background loaded successfully');
            // PNG –∑–∞–≥—Ä—É–∑–∏–ª—Å—è - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º PNG, —Å–∫—Ä—ã–≤–∞–µ–º SVG
            pngBg.style.display = 'block';
            svgBg.style.display = 'none';
            wrapper.classList.remove('bg-fallback');
            wrapper.classList.add('bg-loaded');
        };

        testImg.onerror = function() {
            console.warn('‚ö†Ô∏è PNG background failed to load, switching to SVG fallback');
            // PNG –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º SVG
            pngBg.style.display = 'none';
            svgBg.style.display = 'block';
            wrapper.classList.add('bg-fallback');
            wrapper.classList.remove('bg-loaded');
        };

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É PNG
        testImg.src = "{% static 'images/full_water-bg.png' %}";
    }

    document.addEventListener("DOMContentLoaded", function() {
        checkWaterBackground();

        // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        let resizeTimer;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(checkWaterBackground, 250);
        });
    });
</script>
<script>
    // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Django –≤ JavaScript
    const waterPoints = [
        {% for point in water_points %}
        {
            id: {{ point.id|default:"0" }},
            name: "{{ point.name|default:"Taƒçka"|escapejs }}",
            address: "{{ point.address|default:"Adresa nije navedena"|escapejs }}",
            city: "{{ point.city|default:"Grad nije naveden"|escapejs }}",
            lat: {{ point.latitude|default:"44.0165"|stringformat:".6f" }},
            lng: {{ point.longitude|default:"21.0059"|stringformat:".6f" }}
        }{% if not forloop.last %},{% endif %}
        {% empty %}
        // –î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ —Ç–æ—á–µ–∫ –Ω–µ—Ç
        {
            id: 1,
            name: "–ë–µ–ª–≥—Ä–∞–¥ (–¥–µ–º–æ)",
            address: "–¶–µ–Ω—Ç—Ä –≥–æ—Ä–æ–¥–∞",
            city: "–ë–µ–ª–≥—Ä–∞–¥",
            lat: 44.802874,
            lng: 20.465132
        }
        {% endfor %}
    ];

    // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    console.log('Water points data:', waterPoints);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –∫–æ–≥–¥–∞ DOM –∑–∞–≥—Ä—É–∂–µ–Ω
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing water map...');
        if (typeof initWaterMap === 'function') {
            initWaterMap(waterPoints);
        } else {
            console.error('initWaterMap function not found');
            // Fallback - –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—à–∏–±–∫–∏
            const mapElement = document.getElementById('water-map');
            if (mapElement && typeof showErrorMessage === 'function') {
                showErrorMessage(mapElement, new Error(
                    {% if current_language == 'ru' %}
                        '–§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'
                    {% else %}
                        'Funkcija za inicijalizaciju mape nije pronaƒëena'
                    {% endif %}
                ));
            } else if (mapElement) {
                // –†–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –µ—Å–ª–∏ showErrorMessage –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω
                const errorDiv = document.createElement('div');
                errorDiv.className = 'map-error';

                const title = document.createElement('h3');
                title.textContent =
                    {% if current_language == 'ru' %}
                        '–ö–∞—Ä—Ç–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞'
                    {% else %}
                        'Mapa je privremeno nedostupna'
                    {% endif %};
                errorDiv.appendChild(title);

                const message = document.createElement('p');
                message.textContent =
                    {% if current_language == 'ru' %}
                        '–§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.'
                    {% else %}
                        'Funkcija za inicijalizaciju mape nije pronaƒëena. Poku≈°ajte da osve≈æite stranicu.'
                    {% endif %};
                errorDiv.appendChild(message);

                mapElement.appendChild(errorDiv);
            }
        }
    });
</script>
{% endblock %}
