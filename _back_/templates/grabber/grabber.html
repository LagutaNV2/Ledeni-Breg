{% extends 'base.html' %}
{% load static %}

{% block title %}–ò–≥—Ä–∞—á–∫–∏ - Ledeni Breg{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="{% static 'css/map.css' %}">
<link rel="stylesheet" href="{% static 'css/grabber.css' %}">
{% endblock %}

{% block content %}

<section class="toys-page">
    <!-- –°–µ–∫—Ü–∏—è —Å —Ñ–æ–Ω–æ–º: –∑–∞–≥–æ–ª–æ–≤–æ–∫ + —Ñ–æ—Ç–æ + –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="grabber-content-with-bg">
        <!-- –§–æ–Ω SVG –∫–∞–∫ fallback -->
        <div class="igracki-bg-wrap">
            <div class="igracki-bg" aria-hidden="true"
                style="background-image: url('{% static 'images/full-toys-bg.png' %}');">
            </div>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –ø–æ–≤–µ—Ä—Ö —Ñ–æ–Ω–∞ -->
        <div class="container">
            <!-- –ì–µ—Ä–æ–π —Å–µ–∫—Ü–∏—è —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º -->
            <div class="hero-content">
                <div class="title-backdrop">
                    <h1 class="page-title">–ù–∞—à–∏ –∞–≤—Ç–æ–º–∞—Ç—ã —Å –∏–≥—Ä—É—à–∫–∞–º–∏</h1>
                    {% comment %} <p class="hero-subtitle">–ó–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∏–µ —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–ª—è –¥–µ—Ç–µ–π –∏ –≤–∑—Ä–æ—Å–ª—ã—Ö</p> {% endcomment %}
                </div>
            </div>

            <!-- –ë–ª–æ–∫ —Å –∞–≤—Ç–æ–º–∞—Ç–æ–º –∏ —Ç–µ–∫—Å—Ç–æ–º -->
            <div class="automats-block">
                <div class="automat-content">
                    <div class="automat-image">
                        <img src="{% static 'images/automats/automat-red.png' %}" alt="–ò–≥—Ä–∞—á–∫–∏ –∞–≤—Ç–æ–º–∞—Ç Ledeni Breg" class="automat-img">
                    </div>
                    <div class="automat-text">
                        <h2>–í–µ—Å—ë–ª—ã–µ –∏–≥—Ä—É—à–∫–∏ –¥–ª—è –≤—Å–µ—Ö</h2>
                        <div class="text-content">
                            <p>–ó–∞–±–∞–≤–Ω—ã–µ –∏ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∏–µ –∞–≤—Ç–æ–º–∞—Ç—ã —Å –∏–≥—Ä—É—à–∫–∞–º–∏ –¥–ª—è –¥–µ—Ç–µ–π –∏ –≤–∑—Ä–æ—Å–ª—ã—Ö!
                            –ù–∞—à–∏ –∞–ø–ø–∞—Ä–∞—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ü–µ–Ω—Ç—Ä–∞—Ö, —Ä–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–ø–ª–µ–∫—Å–∞—Ö
                            –∏ –¥—Ä—É–≥–∏—Ö –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö –ø–æ –≤—Å–µ–π –°–µ—Ä–±–∏–∏.</p>

                            <p>–®–∏—Ä–æ–∫–∏–π –≤—ã–±–æ—Ä –∏–≥—Ä—É—à–µ–∫, –º—è–≥–∫–∏—Ö –∂–∏–≤–æ—Ç–Ω—ã—Ö –∏ –∫–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤.
                            –ü—Ä–æ—Å—Ç–æ–π –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–µ–ª–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –∏–≥—Ä—ã —É–¥–æ–±–Ω—ã–º –∏ –ø—Ä–∏—è—Ç–Ω—ã–º
                            –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤—Å–µ—Ö –≤–æ–∑—Ä–∞—Å—Ç–æ–≤.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ë–ª–æ–∫ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ä—Ç—ã -->
    <div class="map-section">
        <div class="container">
            <h2 class="section-title">–ù–∞–π–¥–∏—Ç–µ –∞–≤—Ç–æ–º–∞—Ç —Ä—è–¥–æ–º —Å –≤–∞–º–∏</h2>
            <p class="map-hint" style="text-align: center; color: #666; margin-bottom: 1rem;">
                –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É <strong>üìã</strong> –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö —Ç–æ—á–µ–∫
            </p>
            <div id="grabber-map" class="interactive-map"></div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="{% static 'js/map-common.js' %}"></script>
<script src="{% static 'js/grabber-map.js' %}"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    const page = document.querySelector('.toys-page');
    const testImg = new Image();

    testImg.onload = function() {
        console.log('‚úÖ PNG background loaded successfully.');
    };

    testImg.onerror = function() {
        console.warn('‚ö†Ô∏è PNG background failed to load, switching to SVG fallback.');
        page.classList.add('bg-fallback');

        // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ SVG —Ñ–æ–Ω–∞ –±–µ–∑ innerHTML
        const svgWrap = document.createElement('div');
        svgWrap.className = 'igracki-bg-wrap';

        const innerDiv = document.createElement('div');
        innerDiv.className = 'igracki-bg';

        const svgImg = document.createElement('img');
        svgImg.src = "{% static 'images/igracki.svg' %}";
        svgImg.alt = '';
        svgImg.className = 'igracki-svg';

        innerDiv.appendChild(svgImg);
        svgWrap.appendChild(innerDiv);
        page.prepend(svgWrap);
    };

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É PNG
    testImg.src = "{% static 'images/full-toys-bg.png' %}";
});
</script>
<script>
    // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Django –≤ JavaScript
    const grabberPoints = [
        {% for point in grabber_points %}
        {
            id: {{ point.id|default:"0" }},
            name: "{{ point.name|default:"–¢–æ—á–∫–∞"|escapejs }}",
            address: "{{ point.address|default:"–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω"|escapejs }}",
            city: "{{ point.city|default:"–ì–æ—Ä–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω"|escapejs }}",
            lat: {{ point.latitude|default:"44.0165"|stringformat:".6f" }},
            lng: {{ point.longitude|default:"21.0059"|stringformat:".6f" }}
        }{% if not forloop.last %},{% endif %}
        {% empty %}
        // –î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ —Ç–æ—á–µ–∫ –Ω–µ—Ç
        {
            id: 1,
            name: "–ë–µ–ª–≥—Ä–∞–¥ –ò–≥—Ä—É—à–∫–∏ (–¥–µ–º–æ)",
            address: "–¢–æ—Ä–≥–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä",
            city: "–ë–µ–ª–≥—Ä–∞–¥",
            lat: 44.812874,
            lng: 20.475132
        }
        {% endfor %}
    ];

    // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    console.log('Grabber points data:', grabberPoints);

    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing grabber map...');
        if (typeof initGrabberMap === 'function') {
            initGrabberMap(grabberPoints);
        } else {
            console.error('initGrabberMap function not found');
            // Fallback - –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—à–∏–±–∫–∏
            const mapElement = document.getElementById('grabber-map');
            if (mapElement && typeof showErrorMessage === 'function') {
                showErrorMessage(mapElement, new Error('–§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'));
            } else if (mapElement) {
                // –†–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –µ—Å–ª–∏ showErrorMessage –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω
                const errorDiv = document.createElement('div');
                errorDiv.className = 'map-error';

                const title = document.createElement('h3');
                title.textContent = '–ö–∞—Ä—Ç–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
                errorDiv.appendChild(title);

                const message = document.createElement('p');
                message.textContent = '–§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
                errorDiv.appendChild(message);

                mapElement.appendChild(errorDiv);
            }
        }
    });
</script>
{% endblock %}
